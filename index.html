<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ReDopa">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>ReDopa</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- [æ ¸å¿ƒæ¨£å¼] --- */
        body { 
            background-color: #0a0a0a; 
            color: #f5f5f5; 
            font-family: sans-serif; 
            overflow-x: hidden; 
            overscroll-behavior-y: auto; 
        }

        .glass-card { 
            background: rgba(23, 23, 23, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        /* è¦–åœ–å®šä½ï¼šé¿é–‹ç€æµ· */
        .view-section { 
            display: none; 
            position: absolute; 
            width: 100%; 
            left: 0;
            top: calc(80px + env(safe-area-inset-top)); 
            padding-bottom: 120px;
        }

        .active-view { 
            display: block; 
        }

        nav {
            padding-top: env(safe-area-inset-top);
            height: calc(64px + env(safe-area-inset-top)) !important;
        }

        /* --- [åŠ è¼‰èˆ‡è¼¸å…¥å±¤] --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #0a0a0a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            /* ç¢ºä¿åŠ è¼‰ç•«é¢æœ¬èº«å¯ä»¥æ¥æ”¶é»æ“Š */
            pointer-events: auto;
        }

        .login-input {
            background: transparent;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            outline: none;
            padding: 12px;
            font-size: 20px;
            letter-spacing: 0.2em;
            color: white;
            width: 80%;
            max-width: 300px;
            transition: border-color 0.3s;
            /* ä¿®æ­£ iOS é è¨­å…§é™°å½± */
            -webkit-appearance: none;
            border-radius: 0;
        }

        .login-input:focus {
            border-bottom-color: #ffffff;
        }

        #ptr-indicator {
            position: fixed;
            top: calc(64px + env(safe-area-inset-top)); 
            left: 0;
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="px-4 md:px-8">

    <div id="ptr-indicator">
        <span id="ptr-icon" class="text-[10px] text-neutral-500 uppercase tracking-widest font-bold">Pull to sync</span>
    </div>

    <div id="loading-screen">
        <img src="icon.png" alt="ReDopa" class="w-20 h-20 mb-10 animate-pulse rounded-2xl grayscale border border-white/5">
        
        <div id="boot-container" class="w-64">
            <div class="w-full h-0.5 bg-neutral-800 rounded-full overflow-hidden">
                <div id="loading-bar" style="width: 0%" class="h-full bg-white"></div>
            </div>
            <p id="boot-text" class="text-[9px] text-neutral-600 mt-4 tracking-[0.4em] uppercase text-center">System Initializing</p>
        </div>

        <div id="login-container" class="hidden flex flex-col items-center w-full px-10">
            <p class="text-[10px] text-neutral-400 tracking-[0.4em] uppercase mb-8">Access Protocol Required</p>
            <input type="text" id="user-input-field" class="login-input" placeholder="USERNAME" autocomplete="off" enterkeyhint="done">
            <button onclick="handleLoginSubmit()" class="mt-12 px-10 py-3 border border-white/10 rounded-full text-[10px] tracking-[0.2em] hover:bg-white hover:text-black transition-all active:scale-95">
                EXECUTE LOGIN
            </button>
        </div>
    </div>

    <nav class="fixed top-0 left-0 w-full glass-card z-50 border-b border-white/5 px-4">
        <div class="max-w-2xl mx-auto h-full flex items-center justify-between">
            <div onclick="location.reload()" class="flex items-center gap-2 cursor-pointer group active:scale-95 transition-transform">
                <img src="icon.png" alt="Logo" class="w-6 h-6 rounded-md grayscale transition-all border border-white/10">
                <div class="font-bold text-xl text-white tracking-tighter">ReDopa</div>
            </div>
            <div class="flex gap-4 md:gap-6">
                <button onclick="switchView('home')" id="nav-home" class="nav-link active text-sm md:text-base">ä¸»é </button>
                <button onclick="switchView('history')" id="nav-history" class="nav-link text-sm md:text-base">æ­·å²</button>
                <button onclick="switchView('settings')" id="nav-settings" class="nav-link text-sm md:text-base">è¨­å®š</button>
            </div>
        </div>
    </nav>

    <main id="view-home" class="view-section active-view">
        <div class="max-w-2xl mx-auto px-4">
            <header class="mb-10 text-center">
                <h1 class="text-[10px] uppercase tracking-[0.3em] text-neutral-500 mb-2">Neural Reward Accumulation</h1>
                <div id="total-score" class="text-7xl font-bold text-white">0</div>
                <p id="status-insight" class="text-xs text-neutral-400 mt-4 italic">"Seeking focus within the silence."</p>
            </header>
            <div id="stats-dashboard" class="flex flex-wrap gap-2 mb-10 justify-center"></div>
            <div class="flex justify-between items-center mb-6">
                <h2 id="quest-title" class="text-xs font-bold text-neutral-500 uppercase tracking-[0.2em]">Mission Protocol</h2>
                <button id="clear-filter" onclick="setFilter(null)" class="hidden text-[10px] text-white border border-white/10 px-2 py-1 rounded">RESET FILTER</button>
            </div>
            <div id="quest-container" class="space-y-4"></div>
        </div>
    </main>

    <main id="view-history" class="view-section">
        <div class="max-w-2xl mx-auto px-4">
            <h1 class="text-2xl font-bold mb-6">ğŸ“… æ­·å²è»Œè·¡</h1>
            <div class="glass-card rounded-2xl p-6 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xs text-neutral-500 uppercase tracking-widest">Growth Curve</h2>
                    <div class="flex gap-2">
                        <button onclick="changeRange('month')" id="btn-month" class="btn-toggle text-[10px] px-3 py-1 rounded-full active">1M</button>
                        <button onclick="changeRange('year')" id="btn-year" class="btn-toggle text-[10px] px-3 py-1 rounded-full">1Y</button>
                        <button onclick="changeRange('all')" id="btn-all" class="btn-toggle text-[10px] px-3 py-1 rounded-full">ALL</button>
                    </div>
                </div>
                <div class="h-[200px]"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl overflow-hidden border border-white/5">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-neutral-900 text-neutral-400 text-[10px] uppercase tracking-widest">
                        <tr><th class="p-4">Date</th><th class="p-4 text-center">Score</th><th class="p-4">Progress</th></tr>
                    </thead>
                    <tbody id="history-table-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </main>

    <main id="view-settings" class="view-section">
        <div class="max-w-2xl mx-auto px-4">
            <h1 class="text-2xl font-bold mb-8">âš™ï¸ æ ¸å¿ƒè¨­å®š</h1>
            <section class="glass-card rounded-2xl p-6 mb-8">
                <h2 class="text-white font-semibold mb-4 border-b border-white/5 pb-2 text-sm uppercase tracking-widest">1. åˆ†é¡ç®¡ç†</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-cat-input" placeholder="åç¨±" class="flex-1 bg-neutral-900 rounded-lg p-3 outline-none border border-white/5 text-sm">
                    <button onclick="addCategory()" class="bg-white text-black px-6 py-2 rounded-lg text-xs font-bold uppercase">Add</button>
                </div>
                <div id="cat-tags" class="flex flex-wrap gap-2"></div>
            </section>
            <section class="glass-card rounded-2xl p-6 mb-8">
                <h2 class="text-white font-semibold mb-4 border-b border-white/5 pb-2 text-sm uppercase tracking-widest">2. ä»»å‹™å®šç¾©</h2>
                <div class="space-y-4 mb-6">
                    <input type="text" id="task-name" placeholder="ä»»å‹™å…§å®¹" class="w-full bg-neutral-900 rounded-lg p-3 outline-none border border-white/5 text-sm">
                    <div class="flex gap-2">
                        <select id="task-cat-select" class="flex-1 bg-neutral-900 rounded-lg p-3 outline-none border border-white/5 text-xs"></select>
                        <input type="number" id="task-score" placeholder="Pts" class="w-24 bg-neutral-900 rounded-lg p-3 outline-none border border-white/5 text-sm">
                    </div>
                    <button onclick="addTask()" class="w-full bg-white text-black py-3 rounded-lg text-xs font-bold uppercase tracking-widest">Register Task</button>
                </div>
                <ul id="task-manage-list" class="space-y-2 border-t border-white/5 pt-4"></ul>
            </section>
            <section class="glass-card rounded-2xl p-6 border-red-900/20 text-center">
                <button onclick="resetAll()" class="text-red-500/50 border border-red-900/10 px-4 py-1 rounded text-[10px] uppercase tracking-[0.2em]">Factory Reset</button>
            </section>
        </div>
    </main>

    <script>
        const supabaseUrl = 'https://okesrvqivpqvahmenafx.supabase.co';
        const supabaseKey = 'sb_publishable_QCthF4rOOZH0XUb4KQXUtA_I2LZM1JJ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let state = {
            categories: JSON.parse(localStorage.getItem('ds_categories')) || ['ä¸€èˆ¬'],
            tasks: JSON.parse(localStorage.getItem('ds_tasks')) || [],
            completions: JSON.parse(localStorage.getItem('ds_completions')) || {}
        };
        const today = new Date().toISOString().split('T')[0];
        let currentUser = localStorage.getItem('redopa_user');
        let growthChart = null, currentChartRange = 'month', currentFilter = null;

        // --- [åŠŸèƒ½å‡½å¼é›†] ---
        async function loadStateFromServer() {
            if (!currentUser) return;
            try {
                const { data } = await supabaseClient.from('redopa_data').select('state_json').eq('username', currentUser).single();
                if (data?.state_json) state = data.state_json;
            } catch (err) { console.log("Sync bypassed."); }
        }

        async function saveState() {
            localStorage.setItem('ds_categories', JSON.stringify(state.categories));
            localStorage.setItem('ds_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('ds_completions', JSON.stringify(state.completions));
            if (currentUser) await supabaseClient.from('redopa_data').upsert({ username: currentUser, state_json: state }, { onConflict: 'username' });
        }

        function switchView(view) {
            const sections = ['view-home', 'view-settings', 'view-history'];
            sections.forEach(s => { const el = document.getElementById(s); if (el && el.style.display !== 'none') gsap.to(el, { opacity: 0, y: 10, duration: 0.2, onComplete: () => el.style.display = 'none' }); });
            setTimeout(() => {
                const target = document.getElementById(`view-${view}`);
                if(target) { target.style.display = 'block'; gsap.fromTo(target, { opacity: 0, y: -10 }, { opacity: 1, y: 0, duration: 0.3 }); }
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                const btn = document.getElementById(`nav-${view}`);
                if(btn) btn.classList.add('active');
                if (view === 'home') renderHome();
                if (view === 'settings') renderSettings();
                if (view === 'history') { renderHistory(); renderChart(currentChartRange); }
            }, 250);
        }

        function calculateDailyScore(dateStr) { const doneIds = state.completions[dateStr] || []; return state.tasks.reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0); }
        function calculateMonthlyScore(yearMonth) { return Object.keys(state.completions).filter(d => d.startsWith(yearMonth)).reduce((t, d) => t + calculateDailyScore(d), 0); }
        function setFilter(cat) { currentFilter = cat; renderHome(); }

        function renderHome() {
            const stats = document.getElementById('stats-dashboard');
            const quest = document.getElementById('quest-container');
            if(!stats || !quest) return;
            const doneIds = state.completions[today] || [];
            stats.innerHTML = state.categories.map(cat => {
                const catScore = state.tasks.filter(t => t.category === cat).reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0);
                return `<div onclick="setFilter('${cat}')" class="glass-card px-4 py-3 rounded-xl border ${currentFilter===cat?'border-white':'border-white/5'} cursor-pointer min-w-[90px] transition-all">
                            <div class="text-[9px] text-neutral-500 uppercase font-bold text-center mb-1">${cat}</div>
                            <div class="text-xl font-bold text-white text-center">${catScore}</div>
                        </div>`;
            }).join('');
            document.getElementById('clear-filter').style.display = currentFilter ? 'block' : 'none';
            const displayCats = currentFilter ? [currentFilter] : state.categories;
            quest.innerHTML = displayCats.map(cat => {
                const tasks = state.tasks.filter(t => t.category === cat);
                if (!tasks.length) return '';
                return `<div class="mb-8"><h3 class="text-[9px] text-neutral-600 mb-3 uppercase tracking-widest pl-2 border-l border-white/20">${cat}</h3>
                        <div class="space-y-2">${tasks.map(t => `<label class="glass-card p-5 rounded-2xl flex items-center gap-4 cursor-pointer active:bg-white/5 transition-colors">
                            <input type="checkbox" class="w-5 h-5 accent-white rounded bg-black" ${doneIds.includes(t.id)?'checked':''} onchange="toggleTask(${t.id})">
                            <span class="flex-1 text-sm ${doneIds.includes(t.id)?'line-through text-neutral-600':''}">${t.name}</span>
                            <span class="text-white font-mono text-xs">${t.score}</span>
                        </label>`).join('')}</div></div>`;
            }).join('');
            gsap.to("#total-score", { innerHTML: calculateDailyScore(today), duration: 0.5, snap: { innerHTML: 1 } });
        }

        // --- [ç™»å…¥æ ¸å¿ƒä¿®æ­£ï¼šå¢åŠ å¼·åˆ¶å°ç„¦] ---
        async function handleLoginSubmit() {
            const input = document.getElementById('user-input-field');
            const username = input.value.trim();
            if (username) {
                currentUser = username;
                localStorage.setItem('redopa_user', currentUser);
                gsap.to('#login-container', { opacity: 0, y: 10, duration: 0.3, onComplete: () => {
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('boot-container').classList.remove('hidden');
                    continueBootstrap();
                }});
            }
        }

        // --- [ç³»çµ±å•Ÿå‹•å¼•å°] ---
        async function bootstrap() {
            const bar = document.getElementById('loading-bar');
            gsap.to(bar, { width: '20%', duration: 0.8, ease: "power2.out" });

            if (!currentUser) {
                // å¦‚æœéœ€è¦ç™»å…¥ï¼Œåˆ‡æ› UI ä¸¦å¼·åˆ¶å°ç„¦
                document.getElementById('boot-container').classList.add('hidden');
                const loginBox = document.getElementById('login-container');
                loginBox.classList.remove('hidden');
                
                gsap.fromTo(loginBox, { opacity: 0, y: 20 }, { 
                    opacity: 1, y: 0, duration: 0.6,
                    onComplete: () => {
                        // é—œéµï¼šGSAP å‹•ç•«çµæŸå¾Œ 200ms å¼·åˆ¶å°ç„¦è¼¸å…¥æ¡†
                        setTimeout(() => {
                            const input = document.getElementById('user-input-field');
                            input.focus();
                            // åœ¨ iOS ä¸‹ï¼Œæœ‰æ™‚éœ€è¦è§¸ç™¼ä¸€å€‹éš±å½¢çš„ click æ‰èƒ½é–‹éµç›¤
                            input.click();
                        }, 200);
                    }
                });
            } else {
                continueBootstrap();
            }
        }

        async function continueBootstrap() {
            const bar = document.getElementById('loading-bar');
            document.getElementById('boot-text').innerText = "Syncing Neural Channels...";
            gsap.to(bar, { width: '60%', duration: 0.5 });
            await loadStateFromServer();
            gsap.to(bar, { width: '100%', duration: 0.4, onComplete: () => {
                setTimeout(() => {
                    const screen = document.getElementById('loading-screen');
                    if(screen) { screen.style.opacity = '0'; setTimeout(() => { screen.style.display = 'none'; renderHome(); }, 600); }
                }, 200);
            }});
        }

        // ç›£è½ Enter éµä¸¦ä¿®æ­£ iOS ä¸‹çš„ input æŠ–å‹•
        document.getElementById('user-input-field').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.target.blur(); // æ”¶èµ·éµç›¤
                handleLoginSubmit();
            }
        });

        // æ­·å²åœ–è¡¨ã€ç®¡ç†åŠŸèƒ½ã€ä¸‹æ‹‰é‡æ•´ç­‰é‚è¼¯ä¿æŒä¸è®Š (çœç•¥ä»¥ç¢ºä¿çµæ§‹æ¸…æ™°)
        // [æ­¤è™•è«‹ä¿ç•™æ‚¨ä¸Šä¸€ç‰ˆæœ¬ä¸­çš„ renderChart, toggleTask, addTask, deleteTask ç­‰ç®¡ç†å‡½å¼]
        
        bootstrap();
    </script>
</body>
</html>
