<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ReDopa">
    <link rel="apple-touch-icon" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReDopa - Dopamine Rebuild System</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .view-section { display: none; position: absolute; width: 100%; top: 80px; }
        .active-view { display: block; }
        .nav-link.active { color: #10b981; border-bottom: 2px solid #10b981; }
        .btn-toggle { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(16, 185, 129, 0.2); transition: all 0.3s; }
        .btn-toggle.active { background: #10b981; color: #0f172a; border-color: #10b981; }
        #sync-indicator { position: fixed; bottom: 20px; right: 20px; font-size: 10px; color: #10b981; opacity: 0; transition: opacity 0.3s; z-index: 100; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="sync-indicator" class="glass-card px-3 py-1 rounded-full">â˜ï¸ åŒæ­¥ä¸­...</div>

    <nav class="fixed top-0 left-0 w-full h-16 glass-card z-50 px-8 flex items-center justify-between">
        <div class="font-bold text-xl text-emerald-400 tracking-tighter">ReDopa</div>
        <div class="flex gap-4 md:gap-6">
            <button onclick="switchView('home')" id="nav-home" class="nav-link active text-sm md:text-base">ä¸»é </button>
            <button onclick="switchView('history')" id="nav-history" class="nav-link text-sm md:text-base">æ­·å²</button>
            <button onclick="switchView('settings')" id="nav-settings" class="nav-link text-sm md:text-base">è¨­å®š</button>
        </div>
    </nav>

    <main id="view-home" class="view-section active-view max-w-xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-xs uppercase tracking-widest text-slate-400">Total Reward Today</h1>
            <div id="total-score" class="text-7xl font-bold text-emerald-400">0</div>
            <p id="status-insight" class="text-xs text-slate-500 mt-2 italic">"æº–å‚™å¥½é–‹å§‹ä»Šå¤©çš„é‡å»ºäº†å—ï¼Ÿ"</p>
        </header>

        <div id="stats-dashboard" class="flex flex-wrap gap-2 mb-8 justify-center"></div>

        <div class="flex justify-between items-center mb-4">
            <h2 id="quest-title" class="text-sm font-bold text-slate-400 uppercase tracking-widest pl-2">Quest Log</h2>
            <button id="clear-filter" onclick="setFilter(null)" class="hidden text-[10px] text-emerald-500 border border-emerald-500/30 px-2 py-1 rounded">é¡¯ç¤ºå…¨éƒ¨</button>
        </div>
        <div id="quest-container" class="space-y-4"></div>
    </main>

    <main id="view-history" class="view-section max-w-2xl mx-auto pb-20">
        <h1 class="text-2xl font-bold mb-6">ğŸ“… æˆé•·æ­·å²ç´€éŒ„</h1>
        
        <div class="glass-card rounded-2xl p-4 mb-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xs text-slate-400 uppercase tracking-widest">Growth Trend</h2>
                <div class="flex gap-2">
                    <button onclick="changeRange('month')" id="btn-month" class="btn-toggle text-[10px] px-3 py-1 rounded-full active">ä¸€å€‹æœˆ</button>
                    <button onclick="changeRange('year')" id="btn-year" class="btn-toggle text-[10px] px-3 py-1 rounded-full">ä¸€å¹´</button>
                    <button onclick="changeRange('all')" id="btn-all" class="btn-toggle text-[10px] px-3 py-1 rounded-full">å…¨æ™‚æœŸ</button>
                </div>
            </div>
            <canvas id="growthChart" height="180"></canvas>
        </div>

        <div class="glass-card rounded-2xl overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-slate-800/80 text-emerald-400 text-xs uppercase tracking-wider">
                    <tr>
                        <th class="p-4">æ—¥æœŸ</th>
                        <th class="p-4 text-center">ç¸½åˆ†æ•¸</th>
                        <th class="p-4">å®Œæˆé …ç›®æ•¸</th>
                    </tr>
                </thead>
                <tbody id="history-table-body" class="text-sm"></tbody>
            </table>
        </div>
    </main>

    <main id="view-settings" class="view-section max-w-xl mx-auto pb-20">
        <h1 class="text-2xl font-bold mb-8">âš™ï¸ ç³»çµ±è¨­å®šä¸­å¿ƒ</h1>
        
        <section class="glass-card rounded-2xl p-6 mb-8">
            <h2 class="text-emerald-400 font-semibold mb-4">1. åˆ†é¡ç®¡ç†</h2>
            <div class="flex gap-2 mb-4">
                <input type="text" id="new-cat-input" placeholder="ä¾‹å¦‚ï¼šèº«é«”ã€å¿ƒæ™º" class="flex-1 bg-slate-800 rounded-lg p-2 outline-none">
                <button onclick="addCategory()" class="bg-emerald-600 px-4 py-2 rounded-lg text-sm">æ–°å¢åˆ†é¡</button>
            </div>
            <div id="cat-tags" class="flex flex-wrap gap-2"></div>
        </section>

        <section class="glass-card rounded-2xl p-6 mb-8">
            <h2 class="text-emerald-400 font-semibold mb-4">2. ä»»å‹™ç®¡ç†</h2>
            <div class="space-y-3 mb-6">
                <input type="text" id="task-name" placeholder="ä»»å‹™åç¨±" class="w-full bg-slate-800 rounded-lg p-2 outline-none">
                <div class="flex gap-2">
                    <select id="task-cat-select" class="flex-1 bg-slate-800 rounded-lg p-2 outline-none"></select>
                    <input type="number" id="task-score" placeholder="åˆ†æ•¸" class="w-24 bg-slate-800 rounded-lg p-2 outline-none">
                </div>
                <button onclick="addTask()" class="w-full bg-emerald-600 py-2 rounded-lg font-bold">æ–°å¢è‡³æ¸…å–®</button>
            </div>
            <ul id="task-manage-list" class="space-y-2 border-t border-slate-700 pt-4"></ul>
        </section>

        <section class="glass-card rounded-2xl p-6 border-red-500/30 text-center">
            <h2 class="text-red-400 font-semibold mb-2">3. å±éšªå€åŸŸ</h2>
            <button onclick="resetAll()" class="text-red-500 border border-red-500/50 px-4 py-1 rounded hover:bg-red-500/10 transition-all text-sm">é‡ç½®å…¨éƒ¨è³‡æ–™</button>
        </section>
    </main>

    <script>
        // --- [1. åˆå§‹åŒ– Supabase] ---
        const supabaseUrl = 'https://okesrvqivpqvahmenafx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rZXNydnFpdnBxdmFobWVuYWZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTM0MzUsImV4cCI6MjA4NTUyOTQzNX0.r4SpcQvRd96aJIoRRyxX9yKbJRFzqZ1MAq4XKXjK5HY';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // --- [2. ç‹€æ…‹èˆ‡å…¨åŸŸè®Šæ•¸] ---
        let state = {
            categories: JSON.parse(localStorage.getItem('ds_categories')) || ['å…¶ä»–'],
            tasks: JSON.parse(localStorage.getItem('ds_tasks')) || [],
            completions: JSON.parse(localStorage.getItem('ds_completions')) || {}
        };

        const today = new Date().toISOString().split('T')[0];
        let currentUser = localStorage.getItem('redopa_user');
        let growthChart = null;
        let currentChartRange = 'month';
        let currentFilter = null;

        // --- [3. é›²ç«¯åŒæ­¥é‚è¼¯] ---
        async function loadStateFromServer() {
            if (!currentUser) return;
            showSync(true);
            try {
                const { data, error } = await supabase
                    .from('redopa_data')
                    .select('state_json')
                    .eq('username', currentUser)
                    .single();

                if (data && data.state_json) {
                    state = data.state_json;
                    console.log("é›²ç«¯è³‡æ–™åŒæ­¥æˆåŠŸ");
                }
            } catch (err) {
                console.log("æŸ¥ç„¡é›²ç«¯ç´€éŒ„æˆ–é€£ç·šå•é¡Œï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™ã€‚");
            }
            showSync(false);
        }

        async function saveState() {
            showSync(true);
            // æœ¬åœ°å‚™ä»½
            localStorage.setItem('ds_categories', JSON.stringify(state.categories));
            localStorage.setItem('ds_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('ds_completions', JSON.stringify(state.completions));

            // é›²ç«¯åŒæ­¥
            if (currentUser) {
                const { error } = await supabase
                    .from('redopa_data')
                    .upsert({ 
                        username: currentUser, 
                        state_json: state 
                    }, { onConflict: 'username' });
                if (error) console.error("åŒæ­¥å¤±æ•—:", error);
            }
            showSync(false);
        }

        function showSync(isVisible) {
            document.getElementById('sync-indicator').style.opacity = isVisible ? 1 : 0;
        }

        // --- [4. è¦–åœ–åˆ‡æ›] ---
        function switchView(view) {
            const sections = ['view-home', 'view-settings', 'view-history'];
            sections.forEach(s => {
                const el = document.getElementById(s);
                if (el.style.display !== 'none') {
                    gsap.to(el, { opacity: 0, y: 10, duration: 0.2, onComplete: () => el.style.display = 'none' });
                }
            });

            setTimeout(() => {
                const target = document.getElementById(`view-${view}`);
                target.style.display = 'block';
                gsap.fromTo(target, { opacity: 0, y: -10 }, { opacity: 1, y: 0, duration: 0.3 });
                
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                document.getElementById(`nav-${view}`).classList.add('active');

                if (view === 'home') renderHome();
                if (view === 'settings') renderSettings();
                if (view === 'history') { renderHistory(); renderChart(currentChartRange); }
            }, 250);
        }

        // --- [5. æ ¸å¿ƒè¨ˆç®—èˆ‡åŠŸèƒ½] ---
        function calculateDailyScore(dateStr) {
            const doneIds = state.completions[dateStr] || [];
            return state.tasks.reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0);
        }

        function calculateMonthlyScore(yearMonth) {
            return Object.keys(state.completions)
                .filter(date => date.startsWith(yearMonth))
                .reduce((total, date) => total + calculateDailyScore(date), 0);
        }

        function updateInsight(score) {
            const el = document.getElementById('status-insight');
            let text = score === 0 ? '"ç­‰å¾…ç¬¬ä¸€æ­¥çš„è·¨å‡º..."' : 
                       score < 50 ? '"æ­£åœ¨æš–èº«ï¼Œä¿æŒç¯€å¥ã€‚"' : 
                       score < 100 ? '"æ„Ÿè¦ºåˆ°äº†å—ï¼Ÿå¤šå·´èƒºæ­£åœ¨æ­£ç¢ºåœ°æµå‹•ã€‚"' : '"å“è¶Šçš„æŒæ§åŠ›ï¼Œä½ æ­£åœ¨é‡å»ºè‡ªå·±ã€‚"';
            el.innerText = text;
        }

        function setFilter(cat) { currentFilter = cat; renderHome(); }

        function toggleTask(id) {
            if (!state.completions[today]) state.completions[today] = [];
            const idx = state.completions[today].indexOf(id);
            if (idx > -1) state.completions[today].splice(idx, 1);
            else state.completions[today].push(id);
            saveState(); renderHome();
        }

        // --- [6. è¨­å®šç®¡ç†] ---
        function addCategory() {
            const val = document.getElementById('new-cat-input').value.trim();
            if (val && !state.categories.includes(val)) {
                state.categories.push(val); saveState(); renderSettings();
                document.getElementById('new-cat-input').value = '';
            }
        }

        function deleteCategory(catName) {
            if (catName === 'å…¶ä»–') return alert("ä¸å¯åˆªé™¤é è¨­åˆ†é¡");
            if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${catName}ã€ï¼Ÿç›¸é—œä»»å‹™å°‡æ­¸é¡è‡³ã€Œå…¶ä»–ã€ã€‚`)) {
                state.categories = state.categories.filter(c => c !== catName);
                state.tasks = state.tasks.map(t => t.category === catName ? {...t, category: 'å…¶ä»–'} : t);
                saveState(); renderSettings();
            }
        }

        function addTask() {
            const name = document.getElementById('task-name').value.trim();
            const cat = document.getElementById('task-cat-select').value;
            const score = parseInt(document.getElementById('task-score').value) || 0;
            if (name && cat) {
                state.tasks.push({ id: Date.now(), name, category: cat, score });
                saveState(); renderSettings();
                document.getElementById('task-name').value = ''; document.getElementById('task-score').value = '';
            }
        }

        function deleteTask(id) {
            state.tasks = state.tasks.filter(t => t.id !== id);
            saveState(); renderSettings();
        }

        function resetAll() {
            if (confirm("é€™å°‡æ¸…é™¤æ‰€æœ‰æ•¸æ“šï¼Œç¢ºå®šå—ï¼Ÿ")) { localStorage.clear(); location.reload(); }
        }

        // --- [7. åœ–è¡¨åŠŸèƒ½] ---
        function changeRange(range) {
            currentChartRange = range;
            document.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${range}`).classList.add('active');
            renderChart(range);
        }

        function renderChart(range) {
            const ctx = document.getElementById('growthChart').getContext('2d');
            let labels = []; let scores = [];

            if (range === 'month') {
                for (let i = 29; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const ds = d.toISOString().split('T')[0];
                    labels.push(ds.slice(5)); scores.push(calculateDailyScore(ds));
                }
            } else if (range === 'year') {
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(); d.setMonth(d.getMonth() - i);
                    const ym = d.toISOString().slice(0, 7);
                    labels.push(ym); scores.push(calculateMonthlyScore(ym));
                }
            } else if (range === 'all') {
                const allDates = Object.keys(state.completions).sort();
                if (allDates.length === 0) { labels = ['N/A']; scores = [0]; }
                else {
                    let curr = new Date(new Date(allDates[0]).getFullYear(), new Date(allDates[0]).getMonth(), 1);
                    while (curr <= new Date()) {
                        const ym = curr.toISOString().slice(0, 7);
                        labels.push(ym); scores.push(calculateMonthlyScore(ym));
                        curr.setMonth(curr.getMonth() + 1);
                    }
                }
            }

            if (growthChart) growthChart.destroy();
            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å¾—åˆ†', data: scores,
                        borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2, tension: 0.3, fill: true, pointRadius: range === 'month' ? 2 : 4
                    }]
                },
                options: { 
                    responsive: true, plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.05)' } }, x: { grid: { display: false } } }
                }
            });
        }

        // --- [8. æ¸²æŸ“å‡½æ•¸] ---
        function renderHome() {
            const statsContainer = document.getElementById('stats-dashboard');
            const questContainer = document.getElementById('quest-container');
            const doneIds = state.completions[today] || [];
            
            statsContainer.innerHTML = state.categories.map(cat => {
                const catScore = state.tasks.filter(t => t.category === cat)
                                            .reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0);
                const isActive = currentFilter === cat ? 'border-emerald-500 bg-emerald-500/10' : 'border-transparent';
                return `<div onclick="setFilter('${cat}')" class="glass-card px-4 py-2 rounded-xl border ${isActive} cursor-pointer transition-all hover:scale-105">
                            <div class="text-[10px] text-slate-500 uppercase">${cat}</div>
                            <div class="text-lg font-bold text-emerald-400">${catScore}</div>
                        </div>`;
            }).join('');

            document.getElementById('clear-filter').style.display = currentFilter ? 'block' : 'none';
            document.getElementById('quest-title').innerText = currentFilter ? `Quest: ${currentFilter}` : 'Quest Log';

            const displayCats = currentFilter ? [currentFilter] : state.categories;
            questContainer.innerHTML = displayCats.map(cat => {
                const catTasks = state.tasks.filter(t => t.category === cat);
                if (catTasks.length === 0) return '';
                return `<div class="mb-6"><h3 class="text-xs text-slate-500 mb-2 uppercase pl-2">${cat}</h3>
                        <div class="space-y-2">${catTasks.map(t => `
                            <label class="glass-card p-4 rounded-xl flex items-center gap-4 cursor-pointer">
                                <input type="checkbox" class="w-5 h-5 accent-emerald-500" ${doneIds.includes(t.id) ? 'checked' : ''} onchange="toggleTask(${t.id})">
                                <span class="flex-1">${t.name}</span><span class="text-emerald-400 font-mono">+${t.score}</span>
                            </label>`).join('')}</div></div>`;
            }).join('');

            const todayScore = calculateDailyScore(today);
            gsap.to("#total-score", { innerHTML: todayScore, duration: 0.5, snap: { innerHTML: 1 } });
            updateInsight(todayScore);
        }

        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            const dates = Object.keys(state.completions).sort().reverse();
            if (dates.length === 0) { tbody.innerHTML = `<tr><td colspan="3" class="p-8 text-center text-slate-500">å°šç„¡æ­·å²æ•¸æ“š</td></tr>`; return; }
            tbody.innerHTML = dates.map(date => {
                const doneIds = state.completions[date] || [];
                return `<tr class="border-t border-slate-700 hover:bg-slate-800/30">
                        <td class="p-4 font-mono text-xs text-slate-400">${date}</td>
                        <td class="p-4 text-center"><span class="bg-emerald-500/10 text-emerald-400 px-2 py-1 rounded font-bold">${calculateDailyScore(date)}</span></td>
                        <td class="p-4 text-slate-300 text-xs">å·²å®Œæˆ ${doneIds.length} å€‹é …ç›®</td></tr>`;
            }).join('');
        }

        function renderSettings() {
            document.getElementById('cat-tags').innerHTML = state.categories.map(c => `
                <div class="flex items-center bg-slate-800 px-3 py-1 rounded-full text-xs text-emerald-400 border border-emerald-500/20">
                    <span># ${c}</span><button onclick="deleteCategory('${c}')" class="ml-2 hover:text-red-400">âœ•</button>
                </div>`).join('');
            document.getElementById('task-cat-select').innerHTML = `<option value="">é¸æ“‡åˆ†é¡...</option>` + state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('task-manage-list').innerHTML = state.tasks.map(t => `
                <li class="flex justify-between items-center bg-slate-800/50 p-3 rounded-lg text-sm mb-2">
                    <div><span class="text-xs text-emerald-500 font-mono">[${t.category}]</span><span class="ml-2">${t.name}</span></div>
                    <div class="flex items-center gap-4"><span class="font-bold text-emerald-400">${t.score}</span><button onclick="deleteTask(${t.id})" class="text-red-500">âœ•</button></div>
                </li>`).join('');
        }

        // --- [9. ç³»çµ±å•Ÿå‹•å¼•å°] ---
        async function bootstrap() {
            if (!currentUser) {
                currentUser = prompt("æ­¡è¿ä¾†åˆ° ReDopaï¼è«‹è¼¸å…¥ä½ çš„ä½¿ç”¨è€…åç¨±ä»¥é€²è¡ŒåŒæ­¥ï¼š");
                if (currentUser) localStorage.setItem('redopa_user', currentUser);
            }
            // å˜—è©¦è¼‰å…¥é›²ç«¯è³‡æ–™
            await loadStateFromServer();
            // åˆå§‹æ¸²æŸ“
            renderHome();
        }

        bootstrap();
    </script>
</body>
</html>
