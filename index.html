<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ReDopa">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ReDopa</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- [åŸºç¤èˆ‡æ»¾å‹•è¨­å®š] --- */
        body { 
            background-color: #0a0a0a; 
            color: #f5f5f5; 
            font-family: sans-serif; 
            overflow-x: hidden; 
            overscroll-behavior-y: auto; 
        }

        .glass-card { 
            background: rgba(23, 23, 23, 0.7); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.05); 
        }

        /* è¦–åœ–å®šä½ï¼šé¿é–‹æ‰‹æ©Ÿç€æµ· Safe Area */
        .view-section { 
            display: none; 
            position: absolute; 
            width: 100%; 
            left: 0;
            top: calc(80px + env(safe-area-inset-top)); 
            padding-bottom: 120px;
        }

        .active-view { 
            display: block; 
        }

        /* å°è¦½åˆ—å®‰å…¨å€åŸŸä¿®æ­£ */
        nav {
            padding-top: env(safe-area-inset-top);
            height: calc(64px + env(safe-area-inset-top)) !important;
        }

        .nav-link.active { 
            color: #ffffff; 
            border-bottom: 2px solid #ffffff; 
        }

        /* --- [åŒæ­¥èˆ‡åŠ è¼‰çµ„ä»¶] --- */
        #loading-screen {
            position: fixed;
            inset: 0;
            background-color: #0a0a0a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s ease-out;
            pointer-events: auto; /* ç¢ºä¿åŠ è¼‰å±¤å¯è¢«é»æ“Š */
        }

        #sync-indicator { 
            position: fixed; 
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            right: 20px; 
            font-size: 10px; 
            color: #ffffff; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 100; 
        }

        #ptr-indicator {
            position: fixed;
            top: calc(64px + env(safe-area-inset-top)); 
            left: 0;
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 40;
            opacity: 0;
            transform: translateY(-20px);
        }

        /* --- [ç™»å…¥è¼¸å…¥æ¡†ï¼šä¿®æ­£ PWA è¼¸å…¥é™åˆ¶] --- */
        .login-input {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            outline: none;
            padding: 10px;
            font-size: 18px;
            letter-spacing: 0.15em;
            transition: border-color 0.3s;
            /* ä¿®æ­£ iOS PWA ç„¡æ³•é¸å–èˆ‡é»æ“Šçš„å•é¡Œ */
            -webkit-user-select: text !important;
            user-select: text !important;
            -webkit-appearance: none;
            border-radius: 0;
            pointer-events: auto !important;
        }

        .login-input:focus {
            border-color: #ffffff;
        }

        #login-container {
            pointer-events: auto !important; /* å¼·åˆ¶é–‹æ”¾é»æ“Šç©¿é€ */
        }
    </style>
</head>
<body class="px-4 md:px-8">

    <div id="ptr-indicator">
        <span id="ptr-icon">Pull to sync</span>
    </div>

    <div id="loading-screen">
        <img src="icon.png" alt="ReDopa Icon" class="w-20 h-20 mb-10 animate-pulse rounded-2xl grayscale">
        
        <div id="boot-container" class="w-64">
            <div class="w-full h-1 bg-neutral-800 rounded-full overflow-hidden">
                <div id="loading-bar" style="width: 0%" class="h-full bg-white"></div>
            </div>
            <p id="boot-text" class="text-[9px] text-neutral-500 mt-4 tracking-[0.3em] uppercase text-center">Initializing...</p>
        </div>

        <div id="login-container" class="hidden flex flex-col items-center gap-8">
            <p class="text-[10px] text-neutral-500 tracking-[0.4em] uppercase">Identity Required</p>
            <input type="text" id="user-input-field" class="login-input w-48 text-white" placeholder="USERNAME" autocomplete="off" enterkeyhint="done">
            <button onclick="handleLoginSubmit()" class="mt-4 px-10 py-3 border border-white/10 rounded-full text-[10px] tracking-widest hover:bg-white hover:text-black transition-all active:scale-95">ENTER SYSTEM</button>
        </div>
    </div>

    <div id="sync-indicator" class="glass-card px-3 py-1 rounded-full border-white/20">â˜ï¸ Syncing</div>

    <nav class="fixed top-0 left-0 w-full glass-card z-50 border-b border-white/5 px-4">
        <div class="max-w-2xl mx-auto h-full flex items-center justify-between">
            <div onclick="location.reload()" class="flex items-center gap-2 cursor-pointer group active:scale-95 transition-transform">
                <img src="icon.png" alt="Logo" class="w-6 h-6 rounded-md grayscale group-hover:grayscale-0 transition-all border border-white/10">
                <div class="font-bold text-xl text-white tracking-tighter">ReDopa</div>
            </div>
            <div class="flex gap-4 md:gap-6">
                <button onclick="switchView('home')" id="nav-home" class="nav-link active text-sm md:text-base">ä¸»é </button>
                <button onclick="switchView('history')" id="nav-history" class="nav-link text-sm md:text-base">æ­·å²</button>
                <button onclick="switchView('settings')" id="nav-settings" class="nav-link text-sm md:text-base">è¨­å®š</button>
            </div>
        </div>
    </nav>

    <main id="view-home" class="view-section active-view">
        <div class="max-w-2xl mx-auto">
            <header class="mb-8 text-center px-4">
                <h1 class="text-xs uppercase tracking-[0.2em] text-neutral-500">Reward Accumulation</h1>
                <div id="total-score" class="text-7xl font-bold text-white my-2">0</div>
                <p id="status-insight" class="text-xs text-neutral-400 mt-2 italic">"Seeking focus within the silence."</p>
            </header>
            <div id="stats-dashboard" class="flex flex-wrap gap-2 mb-8 justify-center px-2"></div>
            <div class="px-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="quest-title" class="text-sm font-bold text-neutral-400 uppercase tracking-widest">Mission Protocol</h2>
                    <button id="clear-filter" onclick="setFilter(null)" class="hidden text-[10px] text-white border border-white/20 px-2 py-1 rounded">Show All</button>
                </div>
                <div id="quest-container" class="space-y-4"></div>
            </div>
        </div>
    </main>

    <main id="view-history" class="view-section">
        <div class="max-w-2xl mx-auto px-4">
            <h1 class="text-2xl font-bold mb-6">ğŸ“… æ­·å²è»Œè·¡</h1>
            <div class="glass-card rounded-2xl p-4 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xs text-neutral-500 uppercase tracking-widest text-center">Growth Curve</h2>
                    <div class="flex gap-2">
                        <button onclick="changeRange('month')" id="btn-month" class="btn-toggle text-[10px] px-3 py-1 rounded-full active">1M</button>
                        <button onclick="changeRange('year')" id="btn-year" class="btn-toggle text-[10px] px-3 py-1 rounded-full">1Y</button>
                        <button onclick="changeRange('all')" id="btn-all" class="btn-toggle text-[10px] px-3 py-1 rounded-full">ALL</button>
                    </div>
                </div>
                <div class="h-[200px]"><canvas id="growthChart"></canvas></div>
            </div>
            <div class="glass-card rounded-2xl overflow-hidden border border-white/5">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-neutral-900 text-neutral-400 text-xs uppercase tracking-wider">
                        <tr><th class="p-4">æ—¥æœŸ</th><th class="p-4 text-center">å¾—åˆ†</th><th class="p-4">å®Œæˆåº¦</th></tr>
                    </thead>
                    <tbody id="history-table-body" class="text-sm"></tbody>
                </table>
            </div>
        </div>
    </main>

    <main id="view-settings" class="view-section">
        <div class="max-w-2xl mx-auto px-4">
            <h1 class="text-2xl font-bold mb-8">âš™ï¸ æ ¸å¿ƒè¨­å®š</h1>
            <section class="glass-card rounded-2xl p-6 mb-8">
                <h2 class="text-white font-semibold mb-4 border-b border-white/5 pb-2">1. åˆ†é¡ç®¡ç†</h2>
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-cat-input" placeholder="åç¨±" class="flex-1 bg-neutral-900 rounded-lg p-2 outline-none border border-white/5">
                    <button onclick="addCategory()" class="bg-white text-black px-4 py-2 rounded-lg text-sm font-bold">æ–°å¢</button>
                </div>
                <div id="cat-tags" class="flex flex-wrap gap-2"></div>
            </section>
            <section class="glass-card rounded-2xl p-6 mb-8">
                <h2 class="text-white font-semibold mb-4 border-b border-white/5 pb-2">2. ä»»å‹™å®šç¾©</h2>
                <div class="space-y-3 mb-6">
                    <input type="text" id="task-name" placeholder="å…§å®¹" class="w-full bg-neutral-900 rounded-lg p-2 outline-none border border-white/5">
                    <div class="flex gap-2">
                        <select id="task-cat-select" class="flex-1 bg-neutral-900 rounded-lg p-2 outline-none border border-white/5"></select>
                        <input type="number" id="task-score" placeholder="Pts" class="w-24 bg-neutral-900 rounded-lg p-2 outline-none border border-white/5">
                    </div>
                    <button onclick="addTask()" class="w-full bg-white text-black py-2 rounded-lg font-bold">å„²å­˜ä»»å‹™</button>
                </div>
                <ul id="task-manage-list" class="space-y-2 border-t border-white/5 pt-4"></ul>
            </section>
            <section class="glass-card rounded-2xl p-6 border-red-900/20 text-center">
                <button onclick="resetAll()" class="text-red-500/50 border border-red-900/10 px-4 py-1 rounded text-xs uppercase tracking-widest">Factory Reset</button>
            </section>
        </div>
    </main>

    <script>
        // --- [åˆå§‹åŒ–èˆ‡è®Šæ•¸] ---
        const supabaseUrl = 'https://okesrvqivpqvahmenafx.supabase.co';
        const supabaseKey = 'sb_publishable_QCthF4rOOZH0XUb4KQXUtA_I2LZM1JJ';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        let state = {
            categories: JSON.parse(localStorage.getItem('ds_categories')) || ['ä¸€èˆ¬'],
            tasks: JSON.parse(localStorage.getItem('ds_tasks')) || [],
            completions: JSON.parse(localStorage.getItem('ds_completions')) || {}
        };
        const today = new Date().toISOString().split('T')[0];
        let currentUser = localStorage.getItem('redopa_user');
        let growthChart = null, currentChartRange = 'month', currentFilter = null;

        // --- [ä¸¦è¡Œä¸‹æ‹‰é‡æ–°æ•´ç†æ ¸å¿ƒé‚è¼¯ï¼šä¿®æ­£ RWD åç§»] ---
        let startY = 0, pullDiff = 0;
        const ptrThreshold = 110;

        window.addEventListener('touchstart', (e) => { 
            if (window.scrollY <= 0) { 
                startY = e.touches[0].pageY; 
                pullDiff = 0; 
            } 
        }, { passive: true });

        window.addEventListener('touchmove', (e) => {
            if (window.scrollY > 0) return;
            const currentY = e.touches[0].pageY;
            pullDiff = currentY - startY;

            if (pullDiff > 10) {
                // æŒ‡ç¤ºå™¨å‹•ç•«ä¿®æ­£ï¼šåŒæ­¥è€ƒæ…® Safe Area åç§»
                const move = Math.min(pullDiff * 0.3, 50);
                gsap.set('#ptr-indicator', { y: move, opacity: pullDiff / ptrThreshold });
                document.getElementById('ptr-icon').innerText = pullDiff >= ptrThreshold ? "Release to sync" : "Pull to sync";
            }
        }, { passive: true });

        window.addEventListener('touchend', (e) => {
            if (window.scrollY <= 0 && pullDiff >= ptrThreshold) {
                gsap.to('#ptr-indicator', { y: 0, opacity: 0, duration: 0.2, onComplete: () => {
                    const screen = document.getElementById('loading-screen');
                    screen.style.display = 'flex'; 
                    screen.style.opacity = '1';
                    location.reload();
                }});
            } else { 
                gsap.to('#ptr-indicator', { y: -20, opacity: 0, duration: 0.3, ease: "power2.out" }); 
            }
            pullDiff = 0;
        });

        // --- [è³‡æ–™åº«èˆ‡åŒæ­¥] ---
        async function loadStateFromServer() {
            if (!currentUser) return;
            showSync(true);
            try {
                const { data } = await supabaseClient.from('redopa_data').select('state_json').eq('username', currentUser).single();
                if (data?.state_json) state = data.state_json;
            } catch (err) { console.log("Cloud sync bypassed."); }
            showSync(false);
        }

        async function saveState() {
            showSync(true);
            localStorage.setItem('ds_categories', JSON.stringify(state.categories));
            localStorage.setItem('ds_tasks', JSON.stringify(state.tasks));
            localStorage.setItem('ds_completions', JSON.stringify(state.completions));
            if (currentUser) await supabaseClient.from('redopa_data').upsert({ username: currentUser, state_json: state }, { onConflict: 'username' });
            showSync(false);
        }

        function showSync(isVisible) { 
            const el = document.getElementById('sync-indicator'); 
            if(el) el.style.opacity = isVisible ? 1 : 0; 
        }

        // --- [ç³»çµ±è¦–åœ–åˆ‡æ›] ---
        function switchView(view) {
            const sections = ['view-home', 'view-settings', 'view-history'];
            sections.forEach(s => { 
                const el = document.getElementById(s); 
                if (el && el.style.display !== 'none') gsap.to(el, { opacity: 0, y: 10, duration: 0.2, onComplete: () => el.style.display = 'none' }); 
            });
            setTimeout(() => {
                const target = document.getElementById(`view-${view}`);
                if(target) { target.style.display = 'block'; gsap.fromTo(target, { opacity: 0, y: -10 }, { opacity: 1, y: 0, duration: 0.3 }); }
                document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
                const navBtn = document.getElementById(`nav-${view}`);
                if(navBtn) navBtn.classList.add('active');
                if (view === 'home') renderHome();
                if (view === 'settings') renderSettings();
                if (view === 'history') { renderHistory(); renderChart(currentChartRange); }
            }, 250);
        }

        // --- [æ¸²æŸ“é‚è¼¯] ---
        function calculateDailyScore(dateStr) { 
            const doneIds = state.completions[dateStr] || []; 
            return state.tasks.reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0); 
        }
        function calculateMonthlyScore(yearMonth) { return Object.keys(state.completions).filter(d => d.startsWith(yearMonth)).reduce((t, d) => t + calculateDailyScore(d), 0); }
        function setFilter(cat) { currentFilter = cat; renderHome(); }

        function renderHome() {
            const stats = document.getElementById('stats-dashboard');
            const quest = document.getElementById('quest-container');
            if(!stats || !quest) return;
            const doneIds = state.completions[today] || [];
            stats.innerHTML = state.categories.map(cat => {
                const catScore = state.tasks.filter(t => t.category === cat).reduce((sum, t) => doneIds.includes(t.id) ? sum + t.score : sum, 0);
                const isActive = currentFilter === cat ? 'border-white bg-white/10' : 'border-white/5';
                return `<div onclick="setFilter('${cat}')" class="glass-card px-4 py-2 rounded-xl border ${isActive} cursor-pointer transition-all hover:scale-105 min-w-[80px]">
                            <div class="text-[10px] text-neutral-500 uppercase font-bold text-center">${cat}</div>
                            <div class="text-xl font-bold text-white text-center">${catScore}</div>
                        </div>`;
            }).join('');
            document.getElementById('clear-filter').style.display = currentFilter ? 'block' : 'none';
            const displayCats = currentFilter ? [currentFilter] : state.categories;
            quest.innerHTML = displayCats.map(cat => {
                const catTasks = state.tasks.filter(t => t.category === cat);
                if (catTasks.length === 0) return '';
                return `<div class="mb-6"><h3 class="text-[10px] text-neutral-500 mb-2 uppercase tracking-[0.2em] pl-2 border-l border-white/20">${cat}</h3>
                        <div class="space-y-2">${catTasks.map(t => `
                            <label class="glass-card p-4 rounded-xl flex items-center gap-4 cursor-pointer hover:bg-neutral-900/40 transition-colors">
                                <input type="checkbox" class="w-5 h-5 accent-white rounded bg-black" ${doneIds.includes(t.id) ? 'checked' : ''} onchange="toggleTask(${t.id})">
                                <span class="flex-1 ${doneIds.includes(t.id) ? 'line-through text-neutral-600' : ''}">${t.name}</span>
                                <span class="text-white font-mono text-sm">${t.score}</span>
                            </label>`).join('')}</div></div>`;
            }).join('');
            gsap.to("#total-score", { innerHTML: calculateDailyScore(today), duration: 0.5, snap: { innerHTML: 1 } });
        }

        // --- [ç®¡ç†åŠŸèƒ½é›†] ---
        function toggleTask(id) { if (!state.completions[today]) state.completions[today] = []; const idx = state.completions[today].indexOf(id); if (idx > -1) state.completions[today].splice(idx, 1); else state.completions[today].push(id); saveState(); renderHome(); }
        function addCategory() { const val = document.getElementById('new-cat-input').value.trim(); if (val && !state.categories.includes(val)) { state.categories.push(val); saveState(); renderSettings(); document.getElementById('new-cat-input').value = ''; } }
        function addTask() { 
            const name = document.getElementById('task-name').value.trim(), cat = document.getElementById('task-cat-select').value, score = parseInt(document.getElementById('task-score').value) || 0; 
            if (name && cat) { state.tasks.push({ id: Date.now(), name, category: cat, score }); saveState(); renderSettings(); document.getElementById('task-name').value = ''; document.getElementById('task-score').value = ''; } 
        }
        function deleteTask(id) { state.tasks = state.tasks.filter(t => t.id !== id); saveState(); renderSettings(); }
        function deleteCategory(catName) { if (catName === 'ä¸€èˆ¬') return alert("ä¸å¯åˆªé™¤é è¨­"); if (confirm(`ç¢ºå®šåˆªé™¤ã€Œ${catName}ã€ï¼Ÿ`)) { state.categories = state.categories.filter(c => c !== catName); state.tasks = state.tasks.map(t => t.category === catName ? {...t, category: 'ä¸€èˆ¬'} : t); saveState(); renderSettings(); } }
        function resetAll() { if (confirm("ç¢ºå®šé‡ç½®æ•¸æ“šï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function renderSettings() {
            document.getElementById('cat-tags').innerHTML = state.categories.map(c => `<div class="bg-neutral-900 border border-white/10 px-3 py-1 rounded-full text-xs text-neutral-300 flex items-center gap-2"># ${c}<button onclick="deleteCategory('${c}')">âœ•</button></div>`).join('');
            document.getElementById('task-cat-select').innerHTML = state.categories.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('task-manage-list').innerHTML = state.tasks.map(t => `<li class="flex justify-between items-center bg-neutral-900/50 p-3 rounded-lg text-sm border border-white/5"><div class="flex items-center gap-2"><span class="text-[10px] text-neutral-500">[${t.category}]</span>${t.name}</div><div class="flex items-center gap-4"><span class="font-bold text-white">${t.score}</span><button onclick="deleteTask(${t.id})" class="text-red-900">âœ•</button></div></li>`).join('');
        }
        function renderHistory() { const dates = Object.keys(state.completions).sort().reverse(); document.getElementById('history-table-body').innerHTML = dates.map(d => `<tr class="border-t border-white/5 hover:bg-neutral-900/50 transition-colors"><td class="p-4 font-mono text-neutral-500">${d}</td><td class="p-4 text-center font-bold text-white">${calculateDailyScore(d)}</td><td class="p-4 text-neutral-400 text-xs">${(state.completions[d] || []).length} Missions</td></tr>`).join('') || '<tr><td colspan="3" class="p-8 text-center text-neutral-600 italic">No records.</td></tr>'; }
        function changeRange(range) { currentChartRange = range; document.querySelectorAll('.btn-toggle').forEach(b => b.classList.remove('active')); document.getElementById(`btn-${range}`).classList.add('active'); renderChart(range); }
        function renderChart(range) {
            const canvas = document.getElementById('growthChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let labels = [], scores = [];
            if (range === 'month') { for (let i = 29; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); const ds = d.toISOString().split('T')[0]; labels.push(ds.slice(5)); scores.push(calculateDailyScore(ds)); } }
            else if (range === 'year') { for (let i = 11; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); const ym = d.toISOString().slice(0, 7); labels.push(ym); scores.push(calculateMonthlyScore(ym)); } }
            else if (range === 'all') { const dates = Object.keys(state.completions).sort(); if(dates.length) { let curr = new Date(dates[0].slice(0, 7)); while(curr <= new Date()) { const ym = curr.toISOString().slice(0, 7); labels.push(ym); scores.push(calculateMonthlyScore(ym)); curr.setMonth(curr.setMonth() + 1); } } }
            if (growthChart) growthChart.destroy();
            growthChart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data: scores, borderColor: '#ffffff', backgroundColor: 'rgba(255, 255, 255, 0.05)', borderWidth: 1.5, tension: 0.3, fill: true, pointRadius: range==='month'?0:3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.03)' }, ticks: { color: '#525252' } }, x: { grid: { display: false }, ticks: { color: '#525252' } } } }
            });
        }

        // --- [ç™»å…¥è™•ç†èˆ‡å•Ÿå‹•æµç¨‹] ---
        async function handleLoginSubmit() {
            const input = document.getElementById('user-input-field');
            const username = input.value.trim();
            if (username) {
                currentUser = username;
                localStorage.setItem('redopa_user', currentUser);
                gsap.to('#login-container', { opacity: 0, y: 10, duration: 0.3, onComplete: () => {
                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('boot-container').classList.remove('hidden');
                    continueBootstrap();
                }});
            }
        }

        document.getElementById('user-input-field').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.target.blur(); // å¼·åˆ¶æ”¶èµ·éµç›¤
                handleLoginSubmit();
            }
        });

        async function bootstrap() {
            const bar = document.getElementById('loading-bar');
            gsap.to(bar, { width: '0%', duration: 0.8, ease: "power2.out" });

            if (!currentUser) {
                document.getElementById('boot-container').classList.add('hidden');
                const loginBox = document.getElementById('login-container');
                loginBox.classList.remove('hidden');
                
                gsap.fromTo(loginBox, { opacity: 0, y: 20 }, { 
                    opacity: 1, y: 0, duration: 0.6,
                    onComplete: () => {
                        // é‡å° iOS PWA çš„å°ç„¦ä¿®æ­£ï¼šå»¶é² 300ms ä¸¦æ¨¡æ“¬é»æ“Š
                        setTimeout(() => {
                            const input = document.getElementById('user-input-field');
                            input.focus();
                            input.click(); 
                        }, 300);
                    }
                });
            } else {
                continueBootstrap();
            }
        }

        async function continueBootstrap() {
            const bar = document.getElementById('loading-bar');
            gsap.to(bar, { width: '60%', duration: 0.5 });
            await loadStateFromServer();
            gsap.to(bar, { 
                width: '100%', duration: 0.4, 
                onComplete: () => {
                    setTimeout(() => {
                        const screen = document.getElementById('loading-screen');
                        if(screen) {
                            screen.style.opacity = '0';
                            setTimeout(() => { screen.style.display = 'none'; renderHome(); }, 600);
                        }
                    }, 0);
                }
            });
        }

        bootstrap();
    </script>
</body>
</html>
